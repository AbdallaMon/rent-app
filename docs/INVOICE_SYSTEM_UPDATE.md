# تحديث نظام الفواتير - tar.ad

## 📋 نظرة عامة

تم تحديث نظام الفواتير في مشروع tar.ad لتنفيذ المتطلبات التالية:

1. **إزالة فواتير الإيجار والضرائب من نظام الفواتير الرئيسي**
2. **إضافة نظام عمولة الإدارة** المحسوبة من إجمالي قيمة العقود بناءً على نسبة العمولة المحددة في كل عقار

---

## 🔄 التغييرات المُطبقة

### 1. تعديل منطق معالجة الفواتير
- **الملف**: `src/services/server/invioces.js`
- **التعديل**: تم تعديل دالة `createIncomeOrExpenseFromInvoice` لاستثناء فواتير الإيجار والضرائب
- **الإضافة**: دالة `handleManagementCommission` لحساب وتسجيل عمولة الإدارة

### 2. تحديث واجهة المستخدم
- **الملف**: `src/app/invoices/page.jsx`
- **التعديل**: إزالة خيارات الإيجار والضرائب من قائمة أنواع الفواتير

### 3. تحديث التعريفات
- **الملف**: `src/config/Enums.js`
- **التعديل**: إزالة RENT و TAX من قائمة أنواع الفواتير المعروضة

### 4. تحديث استعلامات البيانات
- **الملف**: `src/services/server/invioces.js`
- **التعديل**: إضافة فلتر لاستثناء فواتير الإيجار والضرائب من نتائج البحث

---

## 🛠️ الملفات الجديدة

### 1. أدوات مساعدة لعمولة الإدارة
- **الملف**: `src/utils/managementCommission.js`
- **الوصف**: دوال مساعدة لحساب عمولات الإدارة والتقارير

### 2. مكون إدارة تحديث النظام
- **الملف**: `src/components/admin/InvoiceSystemManager.jsx`
- **الوصف**: واجهة مستخدم لإدارة تحديث النظام وعرض الإحصائيات

### 3. API تحديث النظام
- **الملف**: `src/app/api/admin/update-invoice-system/route.js`
- **الوصف**: API endpoint لتنفيذ تحديث النظام وجلب الإحصائيات

### 4. صفحة إدارة التحديث
- **الملف**: `src/app/admin/invoice-system/page.jsx`
- **الوصف**: صفحة مخصصة للمدراء لإدارة تحديث النظام

### 5. سكريبت التحديث
- **الملف**: `scripts/update-invoice-system.js`
- **الوصف**: سكريبت قابل للتشغيل المستقل لتحديث النظام

---

## 🚀 كيفية تنفيذ التحديث

### الطريقة الأولى: عبر واجهة الويب (مُوصى بها)
1. قم بتسجيل الدخول كمدير
2. انتقل إلى `/admin/invoice-system`
3. راجع الإحصائيات الحالية
4. اضغط على "بدء تحديث النظام"
5. راجع النتائج والتقارير

### الطريقة الثانية: عبر API
```bash
# جلب الإحصائيات الحالية
curl -X GET http://localhost:3000/api/admin/update-invoice-system

# تنفيذ التحديث
curl -X POST http://localhost:3000/api/admin/update-invoice-system
```

### الطريقة الثالثة: عبر السكريبت
```bash
node scripts/update-invoice-system.js
```

---

## 📊 ما يحدث أثناء التحديث

### 1. تحديد الفواتير المتأثرة
- البحث عن جميع فواتير الإيجار (`RENT`) والضرائب (`TAX`)
- عرض إحصائيات الفواتير الموجودة

### 2. حساب عمولة الإدارة
```javascript
const commissionAmount = (invoiceAmount * propertyCommissionRate) / 100;
```

### 3. تحديث سجلات الدخل
- **إذا كان هناك سجل دخل موجود**: يتم تحديثه ليصبح عمولة إدارة
- **إذا لم يكن هناك سجل**: يتم إنشاء سجل جديد لعمولة الإدارة

### 4. إنشاء التقارير
- عدد الفواتير المُعالجة
- إجمالي عمولات الإدارة
- متوسط عمولة الإدارة
- تفاصيل كل عملية تحديث

---

## 💡 الميزات الجديدة

### 1. حساب عمولة الإدارة التلقائي
- يتم حساب العمولة بناءً على نسبة العمولة المحددة في جدول العقارات
- تسجيل تلقائي لعمولة الإدارة كدخل منفصل

### 2. تقارير مفصلة
- إحصائيات شاملة لعمولات الإدارة
- تقارير حسب العقار والفترة الزمنية
- تتبع تفصيلي لكل عملية

### 3. واجهة إدارة متقدمة
- عرض الإحصائيات الحالية
- إمكانية التحديث بضغطة واحدة
- تقارير مرئية للنتائج

---

## 🔒 الأمان والصلاحيات

### 1. صلاحيات الوصول
- الوصول للصفحة مقتصر على المدراء فقط (`role: 'ADMIN'`)
- التحقق من الصلاحيات في الواجهة الأمامية والخلفية

### 2. الحماية من الأخطاء
- معالجة شاملة للأخطاء المحتملة
- تسجيل مفصل للعمليات
- إمكانية التراجع عن العمليات

---

## 📈 تأثير التحديث على النظام

### قبل التحديث:
- فواتير الإيجار والضرائب تظهر في قائمة الفواتير
- تُسجل كدخل كامل في النظام المحاسبي

### بعد التحديث:
- فواتير الإيجار والضرائب مخفية من قائمة الفواتير
- تُسجل عمولة الإدارة فقط كدخل
- عمولة الإدارة محسوبة بناءً على نسبة العقار

---

## 🛠️ الصيانة والمتابعة

### 1. مراقبة الأداء
- تتبع عمولات الإدارة الجديدة
- مراجعة دورية للحسابات
- التأكد من صحة الحسابات

### 2. التقارير الدورية
- تقارير شهرية لعمولات الإدارة
- مقارنة الأداء قبل وبعد التحديث
- تحليل الاتجاهات والأنماط

### 3. النسخ الاحتياطية
- يُنصح بعمل نسخة احتياطية قبل التحديث
- الاحتفاظ بسجلات التحديث للمراجعة

---

## 📞 الدعم والاستفسارات

في حالة وجود أي مشاكل أو استفسارات حول التحديث:

1. راجع الـ logs في الخادم
2. تحقق من الإحصائيات عبر واجهة الإدارة
3. استخدم الـ API للحصول على تفاصيل إضافية

---

## 🎯 الخلاصة

هذا التحديث يحسن من دقة النظام المحاسبي عبر:
- تسجيل عمولة الإدارة بدلاً من القيمة الكاملة للفواتير
- تحسين التقارير المالية
- توفير مرونة أكبر في إدارة العمولات

التحديث مصمم ليكون آمناً وقابلاً للتراجع مع توفير تقارير مفصلة لكل عملية.
