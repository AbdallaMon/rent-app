"use client";
import React, {useEffect, useRef, useState, useMemo} from "react";
import {
    Alert,
    Box,
    Button,
    Card,
    CardContent,
    Chip,
    CircularProgress,
    Collapse,
    Container,
    FormControl,
    Grid,
    InputLabel,
    MenuItem,
    Paper,
    Select,
    Snackbar,
    Table,
    TableBody,
    TableCell,
    TableContainer,
    TableHead,
    TableRow,
    TextField,
    Typography,
} from "@mui/material";
import {
    Home,
    Business,
    Build,
    Description,
    Security,
    Receipt,
    Payment,
    Pending,
    CheckCircle,
    Warning,
    AccountBalance,
    TrendingDown,
    Visibility,
    Assessment,
    FilterList,
    GetApp,
    Notifications,
    Email,
    WhatsApp,
    Search,
    Clear
} from '@mui/icons-material';
import {DatePicker, LocalizationProvider} from "@mui/x-date-pickers";
import {AdapterDayjs} from "@mui/x-date-pickers/AdapterDayjs";
import {useReactToPrint} from "react-to-print";
import dayjs from "dayjs";
import "dayjs/locale/en-gb";
import InvoicePrint from "./InvoicePrint";
import {formatCurrencyAED} from "@/helpers/functions/convertMoneyToArabic";

const invoiceTypeMapping = {
    ALL: "ÙƒÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±",
    RENT: "Ø¥ÙŠØ¬Ø§Ø±Ø§Øª",
    INSURANCE: "ØªØ£Ù…ÙŠÙ†",
    REGISTRATION: "ØªØ³Ø¬ÙŠÙ„",
    MAINTENANCE: "ØµÙŠØ§Ù†Ø©",
    MANAGEMENT_COMMISSION: "Ø¹Ù…ÙˆÙ„Ø© Ø¥Ø¯Ø§Ø±Ø©",
    CONTRACT_EXPENSE: "Ù…ØµØ§Ø±ÙŠÙ Ø¹Ù‚Ø¯",
    OTHER_EXPENSE: "Ù…ØµØ§Ø±ÙŠÙ Ø£Ø®Ø±Ù‰",
    TAX: "Ø¶Ø±Ø§Ø¦Ø¨",
    OTHER: "Ø£Ø®Ø±Ù‰",
};

// Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª ÙˆØ§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©
const getInvoiceTypeConfig = (invoiceType) => {
    const configs = {
        'RENT': { 
            icon: <Home />, 
            color: '#1976d2', 
            bgColor: '#e3f2fd', 
            label: 'Ø¥ÙŠØ¬Ø§Ø±',
            purpose: 'ØªÙˆØ«ÙŠÙ‚'
        },
        'MANAGEMENT_COMMISSION': { 
            icon: <Business />, 
            color: '#388e3c', 
            bgColor: '#e8f5e8', 
            label: 'Ø¹Ù…ÙˆÙ„Ø© Ø¥Ø¯Ø§Ø±Ø©',
            purpose: 'Ø¯Ø®Ù„'
        },
        'MAINTENANCE': { 
            icon: <Build />, 
            color: '#d32f2f', 
            bgColor: '#ffebee', 
            label: 'ØµÙŠØ§Ù†Ø©',
            purpose: 'Ù…ØµØ±ÙˆÙ'
        },
        'REGISTRATION': { 
            icon: <Description />, 
            color: '#388e3c', 
            bgColor: '#e8f5e8', 
            label: 'ØªØ³Ø¬ÙŠÙ„',
            purpose: 'Ø¯Ø®Ù„'
        },
        'INSURANCE': { 
            icon: <Security />, 
            color: '#388e3c', 
            bgColor: '#e8f5e8', 
            label: 'ØªØ£Ù…ÙŠÙ†',
            purpose: 'Ø¯Ø®Ù„'
        },
        'TAX': { 
            icon: <Receipt />, 
            color: '#f57c00', 
            bgColor: '#fff8e1', 
            label: 'Ø¶Ø±Ø§Ø¦Ø¨',
            purpose: 'ØªÙˆØ«ÙŠÙ‚'
        },
        'CONTRACT_EXPENSE': { 
            icon: <Description />, 
            color: '#d32f2f', 
            bgColor: '#ffebee', 
            label: 'Ù…ØµØ§Ø±ÙŠÙ Ø¹Ù‚Ø¯',
            purpose: 'Ù…ØµØ±ÙˆÙ'
        },
        'OTHER_EXPENSE': { 
            icon: <TrendingDown />, 
            color: '#d32f2f', 
            bgColor: '#ffebee', 
            label: 'Ù…ØµØ§Ø±ÙŠÙ Ø£Ø®Ø±Ù‰',
            purpose: 'Ù…ØµØ±ÙˆÙ'
        },
        'OTHER': { 
            icon: <Description />, 
            color: '#757575', 
            bgColor: '#f5f5f5', 
            label: 'Ø£Ø®Ø±Ù‰',
            purpose: 'Ø£Ø®Ø±Ù‰'
        }
    };
    return configs[invoiceType] || configs.OTHER;
};

// Ù…ÙƒÙˆÙ† Ø¹Ø±Ø¶ Ù†ÙˆØ¹ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…Ø¹ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©
const InvoiceTypeChip = ({ invoiceType, showLabel = true }) => {
    const config = getInvoiceTypeConfig(invoiceType);

    return (
        <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
            <Box 
                sx={{ 
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    width: 32,
                    height: 32,
                    borderRadius: '50%',
                    backgroundColor: config.bgColor,
                    color: config.color
                }}
            >
                {React.cloneElement(config.icon, { fontSize: 'small' })}
            </Box>
            {showLabel && (
                <Box>
                    <Typography variant="body2" fontWeight="medium">
                        {config.label}
                    </Typography>
                    <Typography variant="caption" color="text.secondary">
                        {config.purpose}
                    </Typography>
                </Box>
            )}
        </Box>
    );
};

// Ù…ÙƒÙˆÙ† Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹
const PaymentStatusChip = ({ isPaid, dueDate }) => {
    const isOverdue = dueDate && new Date(dueDate) < new Date();
    
    const config = isPaid ? {
        icon: <CheckCircle />,
        label: 'Ù…Ø¯ÙÙˆØ¹Ø©',
        color: '#388e3c',
        bgColor: '#e8f5e8'
    } : isOverdue ? {
        icon: <Warning />,
        label: 'Ù…ØªØ£Ø®Ø±Ø©',
        color: '#d32f2f',
        bgColor: '#ffebee'
    } : {
        icon: <Pending />,
        label: 'Ù…Ø¹Ù„Ù‚Ø©',
        color: '#f57c00',
        bgColor: '#fff8e1'
    };

    return (
        <Chip
            icon={config.icon}
            label={config.label}
            size="small"
            sx={{
                backgroundColor: config.bgColor,
                color: config.color,
                fontWeight: 'medium',
                '& .MuiChip-icon': {
                    color: config.color
                }
            }}
        />
    );
};

// Ù…ÙƒÙˆÙ† Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
const InvoiceStatsCards = ({ invoices }) => {
    const stats = useMemo(() => {
        const result = {
            companyIncome: { amount: 0, count: 0 },
            ownerExpenses: { amount: 0, count: 0 },
            documentation: { amount: 0, count: 0 },
            total: { amount: 0, count: invoices.length }
        };

        invoices.forEach(invoice => {
            result.total.amount += invoice.amount;
            
            switch(invoice.invoiceType) {
                case 'MANAGEMENT_COMMISSION':
                case 'REGISTRATION':
                case 'INSURANCE':
                    result.companyIncome.amount += invoice.amount;
                    result.companyIncome.count++;
                    break;
                case 'MAINTENANCE':
                case 'CONTRACT_EXPENSE':
                case 'OTHER_EXPENSE':
                    result.ownerExpenses.amount += invoice.amount;
                    result.ownerExpenses.count++;
                    break;
                case 'RENT':
                case 'TAX':
                    result.documentation.amount += invoice.amount;
                    result.documentation.count++;
                    break;
            }
        });

        return result;
    }, [invoices]);

    const cards = [
        {
            title: 'Ø¯Ø®Ù„ Ø§Ù„Ø´Ø±ÙƒØ©',
            icon: <AccountBalance />,
            amount: stats.companyIncome.amount,
            count: stats.companyIncome.count,
            color: '#388e3c',
            bgColor: '#e8f5e8'
        },
        {
            title: 'Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù…ÙÙ„Ø§Ùƒ',
            icon: <TrendingDown />,
            amount: stats.ownerExpenses.amount,
            count: stats.ownerExpenses.count,
            color: '#d32f2f',
            bgColor: '#ffebee'
        },
        {
            title: 'Ù„Ù„ØªÙˆØ«ÙŠÙ‚ ÙˆØ§Ù„Ù…ØªØ§Ø¨Ø¹Ø©',
            icon: <Visibility />,
            amount: stats.documentation.amount,
            count: stats.documentation.count,
            color: '#1976d2',
            bgColor: '#e3f2fd'
        },
        {
            title: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ±',
            icon: <Assessment />,
            amount: stats.total.amount,
            count: stats.total.count,
            color: '#7b1fa2',
            bgColor: '#f3e5f5'
        }
    ];

    return (
        <Grid container spacing={2} sx={{ mb: 3 }}>
            {cards.map((card, index) => (
                <Grid item xs={12} sm={6} md={3} key={index}>
                    <Card 
                        sx={{ 
                            height: '100%',
                            background: `linear-gradient(135deg, ${card.bgColor} 0%, white 100%)`,
                            border: `1px solid ${card.color}20`,
                            transition: 'transform 0.2s, box-shadow 0.2s',
                            '&:hover': {
                                transform: 'translateY(-2px)',
                                boxShadow: 3
                            }
                        }}
                    >
                        <CardContent>
                            <Box sx={{ display: 'flex', alignItems: 'center', mb: 2 }}>
                                <Box 
                                    sx={{ 
                                        p: 1, 
                                        borderRadius: 2, 
                                        backgroundColor: card.color,
                                        color: 'white',
                                        mr: 2
                                    }}
                                >
                                    {card.icon}
                                </Box>
                                <Typography variant="h6" color={card.color} fontWeight="bold">
                                    {card.title}
                                </Typography>
                            </Box>
                            <Typography variant="h4" color={card.color} fontWeight="bold" gutterBottom>
                                {formatCurrencyAED(card.amount)}
                            </Typography>
                            <Typography variant="body2" color="text.secondary">
                                {card.count} ÙØ§ØªÙˆØ±Ø©
                            </Typography>
                        </CardContent>
                    </Card>
                </Grid>
            ))}
        </Grid>
    );
};

const InvoicePage = () => {
    const [properties, setProperties] = useState([]);
    const [selectedProperty, setSelectedProperty] = useState("");
    const [owners, setOwners] = useState([]);
    const [selectedOwner, setSelectedOwner] = useState("");
    const [units, setUnits] = useState([]);
    const [selectedUnits, setSelectedUnits] = useState([]);
    const [startDate, setStartDate] = useState(dayjs().startOf("month"));
    const [endDate, setEndDate] = useState(dayjs().endOf("month"));
    const [invoices, setInvoices] = useState([]);
    const [currentInvoice, setCurrentInvoice] = useState(null);
    const [invoiceType, setInvoiceType] = useState("ALL");
    const [paymentStatusFilter, setPaymentStatusFilter] = useState("ALL");
    const [searchTerm, setSearchTerm] = useState("");
    const [showAdvancedFilters, setShowAdvancedFilters] = useState(false);
    const componentRef = useRef();
    const printRef = useRef();
    const [loading, setLoading] = useState(true);
    const [submitLoading, setSubmitLoading] = useState(false);
    const [printLoading, setPrintLoading] = useState(false);
    const [snackbarOpen, setSnackbarOpen] = useState(false);
    const [authError, setAuthError] = useState(false);
    const [errorMessage, setErrorMessage] = useState("");
    
    // ÙÙ„ØªØ±Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø§Ù„Ùƒ Ø§Ù„Ù…Ø®ØªØ§Ø±
    const filteredProperties = useMemo(() => {
        console.log("ğŸ”— ÙÙ„ØªØ±Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø§Ù„Ùƒ:", selectedOwner);
        console.log("ğŸ“‹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª:", properties.length);
        
        if (!selectedOwner || selectedOwner === "") {
            console.log("âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø§Ù„Ùƒ Ù…Ø®ØªØ§Ø±ØŒ Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª");
            return properties;
        }
        
        const filtered = properties.filter(property => {
            // Ø·Ø±Ù‚ Ù…Ø®ØªÙ„ÙØ© Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø§Ù„Ùƒ ÙÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø±
            const ownerIdMethods = [
                property.client?.id,
                property.clientId,
                property.ownerId,
                property.owner?.id
            ];
            
            console.log(`ğŸ¢ Ø§Ù„Ø¹Ù‚Ø§Ø± ${property.id} (${property.name}):`, {
                'client.id': property.client?.id,
                'clientId': property.clientId,
                'ownerId': property.ownerId,
                'owner.id': property.owner?.id,
                'Ø§Ù„Ù…Ø§Ù„Ùƒ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨': selectedOwner
            });
            
            const propertyOwnerId = ownerIdMethods.find(id => id != null && id !== undefined);
            const matches = propertyOwnerId && String(propertyOwnerId) === String(selectedOwner);
            
            console.log(`${matches ? 'âœ…' : 'âŒ'} Ø§Ù„Ø¹Ù‚Ø§Ø± ${property.id}: ${propertyOwnerId} ${matches ? '==' : '!='} ${selectedOwner}`);
            
            return matches;
        });
        
        console.log("ğŸ¯ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…ÙÙ„ØªØ±Ø©:", filtered.length, "Ù…Ù† Ø£ØµÙ„", properties.length);
        return filtered;
    }, [properties, selectedOwner]);

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…Ø®ØªØ§Ø± Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø§Ù„Ùƒ
    useEffect(() => {
        console.log("ğŸ”„ ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…Ø®ØªØ§Ø± Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø§Ù„Ùƒ");
        
        if (selectedOwner && selectedProperty) {
            console.log("ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ù„ÙƒÙŠØ© Ø§Ù„Ø¹Ù‚Ø§Ø±:", {
                selectedOwner,
                selectedProperty,
                filteredPropertiesCount: filteredProperties.length
            });
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…Ø®ØªØ§Ø± ÙŠÙ†ØªÙ…ÙŠ Ù„Ù„Ù…Ø§Ù„Ùƒ Ø§Ù„Ù…Ø®ØªØ§Ø±
            const propertyBelongsToOwner = filteredProperties.find(p => 
                String(p.id) === String(selectedProperty)
            );
            
            if (!propertyBelongsToOwner) {
                console.log("âŒ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…Ø®ØªØ§Ø± Ù„Ø§ ÙŠÙ†ØªÙ…ÙŠ Ù„Ù„Ù…Ø§Ù„Ùƒ Ø§Ù„Ù…Ø®ØªØ§Ø±ØŒ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†");
                setSelectedProperty("");
            } else {
                console.log("âœ… Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…Ø®ØªØ§Ø± ÙŠÙ†ØªÙ…ÙŠ Ù„Ù„Ù…Ø§Ù„Ùƒ Ø§Ù„Ù…Ø®ØªØ§Ø±");
            }
        } else if (selectedOwner && !selectedProperty) {
            console.log("â„¹ï¸ ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ø§Ù„Ùƒ Ù„ÙƒÙ† Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø¹Ù‚Ø§Ø± Ø¨Ø¹Ø¯");
        } else if (!selectedOwner && selectedProperty) {
            console.log("ğŸ”„ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø§Ù„ÙƒØŒ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ù‚Ø§Ø±");
            setSelectedProperty("");
        }
    }, [selectedOwner, selectedProperty, filteredProperties]);
    useEffect(() => {
        async function fetchProperties() {
            setLoading(true);
            try {
                console.log("ğŸš€ Ø¨Ø¯Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...");
                
                const resProperties = await fetch("/api/fast-handler?id=properties");
                const dataProperties = await resProperties.json();
                console.log("ğŸ“Š Properties response status:", resProperties.status);
                console.log("ğŸ¢ Properties data:", dataProperties); 
                console.log("ğŸ¢ Properties data type:", typeof dataProperties);
                console.log("ğŸ¢ Is properties array:", Array.isArray(dataProperties));
                
                if (dataProperties && Array.isArray(dataProperties)) {
                    console.log("âœ… Setting properties array with", dataProperties.length, "items");
                    setProperties(dataProperties);
                } else if (dataProperties && typeof dataProperties === 'object') {
                    console.log("ğŸ”§ Properties data is object, checking for array property...");
                    if (dataProperties.value && Array.isArray(dataProperties.value)) {
                        console.log("âœ… Found properties in value property with", dataProperties.value.length, "items");
                        setProperties(dataProperties.value);
                    } else if (dataProperties.data && Array.isArray(dataProperties.data)) {
                        console.log("âœ… Found properties in data property with", dataProperties.data.length, "items");
                        setProperties(dataProperties.data);
                    } else {
                        console.log("âŒ No valid properties array found in response");
                        setProperties([]);
                    }
                } else {
                    console.log("âŒ Invalid properties data format");
                    setProperties([]);
                }

                // Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙÙ„Ø§Ùƒ Ø£ÙŠØ¶Ø§Ù‹
                const resOwners = await fetch("/api/fast-handler?id=owner");
                const dataOwners = await resOwners.json();
                console.log("ğŸ“Š Owners response status:", resOwners.status);
                console.log("ğŸ‘¥ Owners data:", dataOwners); 
                console.log("ğŸ‘¥ Owners data type:", typeof dataOwners);
                console.log("ğŸ‘¥ Is owners array:", Array.isArray(dataOwners));
                
                if (dataOwners && Array.isArray(dataOwners)) {
                    console.log("âœ… Setting owners array with", dataOwners.length, "items");
                    setOwners(dataOwners);
                } else if (dataOwners && typeof dataOwners === 'object') {
                    console.log("ğŸ”§ Owners data is object, checking for array property...");
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø®Ø§ØµÙŠØ© value Ø£ÙˆÙ„Ø§Ù‹
                    if (dataOwners.value && Array.isArray(dataOwners.value)) {
                        console.log("âœ… Found owners in value property with", dataOwners.value.length, "items");
                        setOwners(dataOwners.value);
                    } else if (dataOwners.data && Array.isArray(dataOwners.data)) {
                        console.log("âœ… Found owners in data property with", dataOwners.data.length, "items");
                        setOwners(dataOwners.data);
                    } else if (dataOwners.owners && Array.isArray(dataOwners.owners)) {
                        console.log("âœ… Found owners in owners property with", dataOwners.owners.length, "items");
                        setOwners(dataOwners.owners);
                    } else {
                        console.log("âŒ No valid owners array found in response");
                        setOwners([]);
                    }
                } else {
                    console.log("âŒ Invalid owners data format");
                    setOwners([]);
                }
                
                console.log("âœ… ØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­");
            } catch (error) {
                console.error("âŒ ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", error);
                setProperties([]);
                setOwners([]);
            }
            setLoading(false);
        }

        fetchProperties();
    }, []);

    const handleGenerateInvoices = async () => {
        setSubmitLoading(true);
        setErrorMessage("");
        setAuthError(false);
        
        console.log("ğŸ”„ Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø¬Ù„Ø¨ Ø§Ù„ÙÙˆØ§ØªÙŠØ±...");
        console.log("ğŸ“Š Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:");
        console.log("   Ø§Ù„Ù…Ø§Ù„Ùƒ Ø§Ù„Ù…Ø®ØªØ§Ø±:", selectedOwner);
        console.log("   Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…Ø®ØªØ§Ø±:", selectedProperty);
        console.log("   Ù†ÙˆØ¹ Ø§Ù„ÙØ§ØªÙˆØ±Ø©:", invoiceType);
        console.log("   Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…ÙÙ„ØªØ±Ø©:", filteredProperties.length);
        console.log("   Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª:", properties.length);
        
        // Ù…Ù†Ø·Ù‚ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù‚Ø§Ø± Ù„Ù„ÙÙ„ØªØ±Ø©
        let targetProperties = [];
        
        if (selectedProperty) {
            // Ø¹Ù‚Ø§Ø± Ù…Ø­Ø¯Ø¯
            targetProperties = [selectedProperty];
            console.log("ğŸ¯ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…Ø®ØªØ§Ø±:", selectedProperty);
        } else if (selectedOwner && filteredProperties.length > 0) {
            // Ø¬Ù…ÙŠØ¹ Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø§Ù„Ùƒ Ø§Ù„Ù…Ø®ØªØ§Ø±
            targetProperties = filteredProperties.map(p => p.id);
            console.log("ï¿½ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¬Ù…ÙŠØ¹ Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø§Ù„Ùƒ:", targetProperties);
        } else if (properties.length > 0) {
            // Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª
            targetProperties = properties.map(p => p.id);
            console.log("ğŸ˜ï¸ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª:", targetProperties.length, "Ø¹Ù‚Ø§Ø±");
        }
        
        if (targetProperties.length === 0) {
            console.log("âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù‚Ø§Ø±Ø§Øª Ù…ØªØ§Ø­Ø© Ù„Ø¬Ù„Ø¨ Ø§Ù„ÙÙˆØ§ØªÙŠØ±");
            setErrorMessage("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù‚Ø§Ø±Ø§Øª Ù…ØªØ§Ø­Ø© Ù„Ø¬Ù„Ø¨ Ø§Ù„ÙÙˆØ§ØªÙŠØ±");
            setSnackbarOpen(true);
            setSubmitLoading(false);
            return;
        }
        
        // Ø¬Ù„Ø¨ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ù„ÙƒÙ„ Ø¹Ù‚Ø§Ø± ÙˆØ¬Ù…Ø¹Ù‡Ø§
        let allInvoices = [];
        
        for (const propertyId of targetProperties) {
            console.log(`ğŸ” Ø¬Ù„Ø¨ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø±: ${propertyId}`);
            
            const filters = {
                startDate: startDate.toISOString(),
                endDate: endDate.toISOString(),
                propertyId: parseInt(propertyId), // ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ù‡ Ø±Ù‚Ù…
                invoiceType: invoiceType === "ALL" ? undefined : invoiceType,
            };

            try {
                const res = await fetch(
                      `/api/main/invoices?filters=${JSON.stringify(filters)}`,
                );
                
                if (!res.ok) {
                    if (res.status === 401) {
                        throw new Error("ØºÙŠØ± Ù…Ø®ÙˆÙ„ Ù„Ù„ÙˆØµÙˆÙ„ - ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
                    } else if (res.status === 404) {
                        throw new Error("API ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
                    } else {
                        throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…: ${res.status}`);
                    }
                }
                
                const data = await res.json();
                console.log(`ğŸ“‹ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø± ${propertyId}:`, data.data?.length || 0, "ÙØ§ØªÙˆØ±Ø©");
                
                if (data.data && Array.isArray(data.data)) {
                    allInvoices = allInvoices.concat(data.data);
                }
                
            } catch (error) {
                console.error(`âŒ ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø¹Ù‚Ø§Ø± ${propertyId}:`, error);
                // Ù†ØªØ§Ø¨Ø¹ Ù…Ø¹ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰
            }
        }
        
        console.log("ğŸ“‹ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¬Ù„Ø¨Ø©:", allInvoices.length);
        
        if (allInvoices.length > 0) {
            console.log("ğŸ“‹ Ø¹ÙŠÙ†Ø© ÙØ§ØªÙˆØ±Ø© (Ø§Ù„Ø£ÙˆÙ„Ù‰):", JSON.stringify(allInvoices[0], null, 2));
            setInvoices(allInvoices);
            console.log("âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø¨Ù†Ø¬Ø§Ø­");
        } else {
            console.log("âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± ÙÙŠ Ø§Ù„Ù†ØªÙŠØ¬Ø©");
            setInvoices([]);
            setErrorMessage("Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©");
            setSnackbarOpen(true);
        }
        
        setSubmitLoading(false);
            
            console.log("ğŸ“¡ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø®Ø§Ø¯Ù… - status:", res.status);
            console.log("ğŸ“¡ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø®Ø§Ø¯Ù… - ok:", res.ok);
            
            if (!res.ok) {
                if (res.status === 401) {
                    throw new Error("ØºÙŠØ± Ù…Ø®ÙˆÙ„ Ù„Ù„ÙˆØµÙˆÙ„ - ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
                } else if (res.status === 404) {
                    throw new Error("API ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
                } else {
                    throw new Error(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…: ${res.status}`);
                }
            }
            
            const data = await res.json();
            console.log("ğŸ“‹ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„ÙƒØ§Ù…Ù„Ø©:", data);
            console.log("ğŸ“‹ Ù†ÙˆØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", typeof data);
            console.log("ğŸ“‹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙÙˆØ§ØªÙŠØ±:", data.data); 
            console.log("ğŸ“‹ Ø¹Ø¯Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ±:", data.data ? data.data.length : 0);
            
            if (data.data && data.data.length > 0) {
                console.log("ğŸ“‹ Ø¹ÙŠÙ†Ø© ÙØ§ØªÙˆØ±Ø© (Ø§Ù„Ø£ÙˆÙ„Ù‰):", JSON.stringify(data.data[0], null, 2));
                console.log("ğŸ“‹ Ø¹ÙŠÙ†Ø© ÙØ§ØªÙˆØ±Ø© - Ø§Ù„Ø¹Ù‚Ø§Ø±:", data.data[0].property);
                console.log("ğŸ“‹ Ø¹ÙŠÙ†Ø© ÙØ§ØªÙˆØ±Ø© - Ø§Ù„Ù…Ø§Ù„Ùƒ ÙÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø±:", data.data[0].property?.client);
                console.log("ğŸ“‹ Ø¹ÙŠÙ†Ø© ÙØ§ØªÙˆØ±Ø© - Ø§ØªÙØ§Ù‚ÙŠØ© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±:", data.data[0].rentAgreement);
                setInvoices(data.data);
                console.log("âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø¨Ù†Ø¬Ø§Ø­");
            } else {
                console.log("âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± ÙÙŠ Ø§Ù„Ù†ØªÙŠØ¬Ø©");
                setInvoices([]);
            }
        } catch (error) {
            console.error("âŒ ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ÙÙˆØ§ØªÙŠØ±:", error);
            setInvoices([]);
            
            // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø£Ø®Ø·Ø§Ø¡ Ù…Ø®ØªÙ„ÙØ©
            if (error.message.includes("ØºÙŠØ± Ù…Ø®ÙˆÙ„")) {
                setAuthError(true);
                setErrorMessage("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙÙˆØ§ØªÙŠØ±");
            } else {
                setErrorMessage(`Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ÙÙˆØ§ØªÙŠØ±: ${error.message}`);
            }
            
            setSnackbarOpen(true);
        }
        setSubmitLoading(false);
    };

    const handlePrint = useReactToPrint({
        content: () => printRef.current,
        documentTitle: "ÙØ§ØªÙˆØ±Ø©",
        onBeforeGetContent: () => setPrintLoading(true),
        onAfterPrint: () => setPrintLoading(false),
    });

    const renderInvoices = (invoices) => (
          <TableContainer component={Paper} sx={{mb: 4}}>
              <Table>
                  <TableHead>
                      <TableRow sx={{backgroundColor: "primary.main"}}>
                          <TableCell sx={{ color: "white"}}>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©</TableCell>
                          <TableCell sx={{ color: "white"}}>Ù†ÙˆØ¹ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</TableCell>
                          <TableCell sx={{ color: "white"}}>Ø§Ù„Ø¹Ù‚Ø§Ø±</TableCell>
                          <TableCell sx={{ color: "white"}}>Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©</TableCell>
                          <TableCell sx={{ color: "white"}}>Ø§Ù„Ù…Ø¨Ù„Øº</TableCell>
                          <TableCell sx={{ color: "white"}}>Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹</TableCell>
                          <TableCell sx={{ color: "white"}}>ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ§ØªÙˆØ±Ø©</TableCell>
                          <TableCell sx={{ color: "white"}}>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</TableCell>
                      </TableRow>
                  </TableHead>
                  <TableBody>
                      {invoices?.map((invoice) => (
                            <TableRow 
                                key={invoice.id}
                                sx={{
                                    borderLeft: `4px solid ${getInvoiceTypeConfig(invoice.invoiceType).color}`,
                                    '&:hover': {
                                        backgroundColor: `${getInvoiceTypeConfig(invoice.invoiceType).bgColor}40`
                                    }
                                }}
                            >
                                <TableCell>
                                    <Typography variant="body2" fontWeight="medium">
                                        #{invoice.id}
                                    </Typography>
                                </TableCell>
                                
                                <TableCell>
                                    <InvoiceTypeChip invoiceType={invoice.invoiceType} />
                                </TableCell>
                                
                                <TableCell>{invoice.property?.name || "N/A"}</TableCell>
                                
                                <TableCell>
                                    {invoice.rentAgreement?.unit?.number || "N/A"}
                                </TableCell>
                                
                                <TableCell>
                                    <Typography variant="body2" fontWeight="bold">
                                        {formatCurrencyAED(invoice.amount)}
                                    </Typography>
                                </TableCell>
                                
                                <TableCell>
                                    <PaymentStatusChip 
                                        isPaid={!!invoice.paymentId} 
                                        dueDate={invoice.dueDate}
                                    />
                                </TableCell>
                                
                                <TableCell>
                                    {new Date(invoice.createdAt).toLocaleDateString('ar-SA')}
                                </TableCell>
                                
                                <TableCell>
                                    <Box sx={{ display: 'flex', gap: 1, flexWrap: 'wrap' }}>
                                        <Button
                                            variant="outlined"
                                            size="small"
                                            startIcon={<GetApp />}
                                            onClick={() => {
                                                setCurrentInvoice(invoice);
                                                setTimeout(handlePrint, 500);
                                            }}
                                        >
                                            Ø·Ø¨Ø§Ø¹Ø©
                                        </Button>
                                        
                                        {!invoice.paymentId && (
                                            <>
                                                <Button
                                                    variant="outlined"
                                                    size="small"
                                                    color="warning"
                                                    startIcon={<Email />}
                                                    onClick={() => handleSendReminder(invoice)}
                                                >
                                                    ØªØ°ÙƒÙŠØ±
                                                </Button>
                                                
                                                <Button
                                                    variant="outlined"
                                                    size="small"
                                                    color="success"
                                                    startIcon={<WhatsApp />}
                                                    onClick={() => handleSendWhatsApp(invoice)}
                                                >
                                                    ÙˆØ§ØªØ³Ø§Ø¨
                                                </Button>
                                            </>
                                        )}
                                    </Box>
                                </TableCell>
                            </TableRow>
                      ))}
                  </TableBody>
              </Table>
          </TableContainer>
    );

    // ÙÙ„ØªØ±Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø­Ø³Ù†Ø©
    const filteredInvoices = useMemo(() => {
        console.log("=== Ø¨Ø¯Ø¡ ÙÙ„ØªØ±Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ± ===");
        console.log("Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ±:", invoices.length);
        console.log("Ø§Ù„Ù…Ø§Ù„Ùƒ Ø§Ù„Ù…Ø®ØªØ§Ø±:", selectedOwner, "(Ù†ÙˆØ¹:", typeof selectedOwner, ")");
        console.log("Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…Ø®ØªØ§Ø±:", selectedProperty);
        console.log("Ù†ÙˆØ¹ Ø§Ù„ÙØ§ØªÙˆØ±Ø©:", invoiceType);
        
        if (!invoices || invoices.length === 0) {
            console.log("Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ù„Ù„ÙÙ„ØªØ±Ø©");
            return [];
        }
        
        const result = invoices.filter((invoice, index) => {
            console.log(`--- ÙØ­Øµ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ${index + 1}: ${invoice.id} ---`);
            
            // Ù¡. ÙÙ„ØªØ± Ø§Ù„Ù…Ø§Ù„Ùƒ Ø£ÙˆÙ„Ø§Ù‹ (Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰)
            if (selectedOwner && selectedOwner !== "") {
                console.log("ï¿½ ÙØ­Øµ Ø§Ù„Ù…Ø§Ù„Ùƒ (Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰)...");
                
                // Ø§Ù„Ø·Ø±Ù‚ Ø§Ù„ØµØ­ÙŠØ­Ø© Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø§Ù„Ùƒ ÙÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©
                const ownerMethods = [
                    invoice.property?.client?.id,        // Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
                    invoice.property?.clientId,
                    invoice.property?.ownerId,
                    invoice.property?.owner?.id,
                    invoice.clientId,
                    invoice.ownerId,
                    invoice.rentAgreement?.unit?.property?.client?.id,
                    invoice.rentAgreement?.unit?.property?.clientId,
                    invoice.rentAgreement?.unit?.property?.ownerId
                ];
                
                console.log("ğŸ” Ø·Ø±Ù‚ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø§Ù„Ùƒ:", {
                    'property.client.id': invoice.property?.client?.id,
                    'property.clientId': invoice.property?.clientId,
                    'property.ownerId': invoice.property?.ownerId,
                    'Ø§Ù„Ù…Ø§Ù„Ùƒ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨': selectedOwner
                });
                
                const foundOwnerId = ownerMethods.find(id => id != null && id !== undefined);
                
                if (!foundOwnerId) {
                    console.log("âŒ Ù…Ø±ÙÙˆØ¶Ø© - Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù Ù…Ø§Ù„Ùƒ ÙÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©");
                    return false;
                }
                
                const ownerMatches = String(foundOwnerId) === String(selectedOwner);
                console.log(`${ownerMatches ? 'âœ…' : 'âŒ'} Ø§Ù„Ù…Ø§Ù„Ùƒ: ${foundOwnerId} ${ownerMatches ? '==' : '!='} ${selectedOwner}`);
                
                if (!ownerMatches) {
                    return false;
                }
            }

            // Ù¢. ÙÙ„ØªØ± Ø§Ù„Ø¹Ù‚Ø§Ø± Ø«Ø§Ù†ÙŠØ§Ù‹ (Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ø«Ø§Ù†ÙŠØ©)
            if (selectedProperty && selectedProperty !== "") {
                console.log("ğŸ¢ ÙØ­Øµ Ø§Ù„Ø¹Ù‚Ø§Ø± (Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ø«Ø§Ù†ÙŠØ©)...");
                const propertyId = invoice.property?.id || invoice.propertyId;
                console.log("Ù…Ø¹Ø±Ù Ø§Ù„Ø¹Ù‚Ø§Ø± ÙÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©:", propertyId);
                console.log("Ø§Ù„Ø¹Ù‚Ø§Ø± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:", selectedProperty);
                
                if (String(propertyId) !== String(selectedProperty)) {
                    console.log("âŒ Ù…Ø±ÙÙˆØ¶Ø© - Ø§Ù„Ø¹Ù‚Ø§Ø±:", propertyId, "â‰ ", selectedProperty);
                    return false;
                }
                console.log("âœ… Ù…Ù‚Ø¨ÙˆÙ„Ø© - ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¹Ù‚Ø§Ø±");
            }

            // Ù£. ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø«Ø§Ù„Ø«Ø§Ù‹ (Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ø«Ø§Ù„Ø«Ø©)
            if (invoiceType !== "ALL") {
                console.log("ğŸ“‹ ÙØ­Øµ Ù†ÙˆØ¹ Ø§Ù„ÙØ§ØªÙˆØ±Ø© (Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ø«Ø§Ù„Ø«Ø©)...");
                console.log("Ù†ÙˆØ¹ Ø§Ù„ÙØ§ØªÙˆØ±Ø©:", invoice.invoiceType, "Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:", invoiceType);
                
                if (invoice.invoiceType !== invoiceType) {
                    console.log("âŒ Ù…Ø±ÙÙˆØ¶Ø© - Ù†ÙˆØ¹ Ø§Ù„ÙØ§ØªÙˆØ±Ø©:", invoice.invoiceType, "â‰ ", invoiceType);
                    return false;
                }
                console.log("âœ… Ù…Ù‚Ø¨ÙˆÙ„Ø© - Ù†ÙˆØ¹ Ø§Ù„ÙØ§ØªÙˆØ±Ø©");
            }

            // Ù¤. ÙÙ„ØªØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹
            if (paymentStatusFilter !== "ALL") {
                console.log("ğŸ’³ ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹...");
                const isPaid = !!invoice.paymentId;
                const isOverdue = invoice.dueDate && new Date(invoice.dueDate) < new Date();
                
                if (paymentStatusFilter === "PAID" && !isPaid) {
                    console.log("âŒ Ù…Ø±ÙÙˆØ¶Ø© - Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹: ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©");
                    return false;
                }
                if (paymentStatusFilter === "PENDING" && (isPaid || isOverdue)) {
                    console.log("âŒ Ù…Ø±ÙÙˆØ¶Ø© - Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹: Ù„ÙŠØ³Øª Ù…Ø¹Ù„Ù‚Ø©");
                    return false;
                }
                if (paymentStatusFilter === "OVERDUE" && (!isOverdue || isPaid)) {
                    console.log("âŒ Ù…Ø±ÙÙˆØ¶Ø© - Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹: Ù„ÙŠØ³Øª Ù…ØªØ£Ø®Ø±Ø©");
                    return false;
                }
                console.log("âœ… Ù…Ù‚Ø¨ÙˆÙ„Ø© - Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹");
            }

            // Ù¥. ÙÙ„ØªØ± Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù†ØµÙŠ
            if (searchTerm && searchTerm.trim() !== "") {
                console.log("ğŸ” ÙØ­Øµ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù†ØµÙŠ...");
                const searchTermLower = searchTerm.toLowerCase();
                const searchableText = [
                    invoice.id?.toString(),
                    invoice.property?.name,
                    invoice.property?.owner?.name,
                    invoice.rentAgreement?.unit?.number?.toString(),
                    getInvoiceTypeConfig(invoice.invoiceType).label,
                    invoice.amount?.toString()
                ].join(' ').toLowerCase();
                
                if (!searchableText.includes(searchTermLower)) {
                    console.log("âŒ Ù…Ø±ÙÙˆØ¶Ø© - Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù†ØµÙŠ");
                    return false;
                }
                console.log("âœ… Ù…Ù‚Ø¨ÙˆÙ„Ø© - Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù†ØµÙŠ");
            }

            console.log("âœ… Ù…Ù‚Ø¨ÙˆÙ„Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ - Ø§Ù„ÙØ§ØªÙˆØ±Ø©", invoice.id);
            return true;
        });
        
        console.log("=== Ù†ØªÙŠØ¬Ø© Ø§Ù„ÙÙ„ØªØ±Ø© ===");
        console.log("Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…ÙÙ„ØªØ±Ø©:", result.length, "Ù…Ù† Ø£ØµÙ„", invoices.length);
        console.log("Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„Ø©:", result.map(inv => inv.id));
        console.log("=== Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙÙ„ØªØ±Ø© ===");
        
        return result;
    }, [invoices, invoiceType, selectedOwner, selectedProperty, paymentStatusFilter, searchTerm]);

    // Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ ØªØ°ÙƒÙŠØ±
    const handleSendReminder = async (invoice) => {
        try {
            // Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ°ÙƒÙŠØ±
            console.log('Sending reminder for invoice:', invoice.id);
            setSnackbarOpen(true);
        } catch (error) {
            console.error('Error sending reminder:', error);
        }
    };

    // Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± ÙˆØ§ØªØ³Ø§Ø¨
    const handleSendWhatsApp = async (invoice) => {
        try {
            // Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨
            console.log('Sending WhatsApp for invoice:', invoice.id);
            setSnackbarOpen(true);
        } catch (error) {
            console.error('Error sending WhatsApp:', error);
        }
    };

    // Ø¯Ø§Ù„Ø© ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel
    const handleExportToExcel = () => {
        try {
            // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±
            const exportData = filteredInvoices.map(invoice => ({
                'Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©': invoice.id,
                'Ù†ÙˆØ¹ Ø§Ù„ÙØ§ØªÙˆØ±Ø©': getInvoiceTypeConfig(invoice.invoiceType).label,
                'Ø§Ù„Ø¹Ù‚Ø§Ø±': invoice.property?.name || 'N/A',
                'Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©': invoice.rentAgreement?.unit?.number || 'N/A',
                'Ø§Ù„Ù…Ø¨Ù„Øº': invoice.amount,
                'Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹': invoice.paymentId ? 'Ù…Ø¯ÙÙˆØ¹Ø©' : 'Ù…Ø¹Ù„Ù‚Ø©',
                'ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ§ØªÙˆØ±Ø©': new Date(invoice.createdAt).toLocaleDateString('ar-SA'),
                'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚': invoice.dueDate ? new Date(invoice.dueDate).toLocaleDateString('ar-SA') : 'N/A'
            }));

            // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ CSV (ÙŠÙ…ÙƒÙ† ØªØ­Ø³ÙŠÙ†Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙƒØªØ¨Ø© Excel)
            const csvContent = [
                Object.keys(exportData[0]).join(','),
                ...exportData.map(row => Object.values(row).join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `invoices_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        } catch (error) {
            console.error('Error exporting to Excel:', error);
        }
    };

    return (
          <Container
                sx={{
                    p: {
                        xs: 0,
                        md: 1,
                    },
                }}
          >
              <Box sx={{my: 4}}>
                  <Typography variant="h4" gutterBottom>
                      Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ±
                  </Typography>

                  {/* ØªØ­Ø°ÙŠØ± Ù…Ø´ÙƒÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ */}
                  {authError && (
                      <Alert 
                          severity="warning" 
                          sx={{ mb: 3 }}
                          action={
                              <Button color="inherit" size="small" href="/login">
                                  ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                              </Button>
                          }
                      >
                          ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„ÙÙˆØ§ØªÙŠØ±
                      </Alert>
                  )}

                  {/* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© */}
                  <Card sx={{ mb: 3, p: 3 }}>
                      <Typography variant="h6" gutterBottom sx={{ display: 'flex', alignItems: 'center', gap: 1, mb: 3 }}>
                          <FilterList />
                          ÙÙ„Ø§ØªØ± Ø§Ù„Ø¨Ø­Ø«
                      </Typography>
                      
                      <Grid container spacing={3}>
                          {/* ÙÙ„ØªØ± Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ© */}
                          <Grid item xs={12} md={3}>
                              <LocalizationProvider dateAdapter={AdapterDayjs}>
                                  <Box sx={{ display: "flex", flexDirection: "column", gap: 2 }}>
                                      <DatePicker
                                            label="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡"
                                            value={startDate}
                                            onChange={(date) => setStartDate(date)}
                                            renderInput={(params) => <TextField {...params} />}
                                            format="DD/MM/YYYY"
                                      />
                                      <DatePicker
                                            label="ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©"
                                            value={endDate}
                                            onChange={(date) => setEndDate(date)}
                                            renderInput={(params) => <TextField {...params} />}
                                            format="DD/MM/YYYY"
                                      />
                                  </Box>
                              </LocalizationProvider>
                          </Grid>
                          
                          {/* ÙÙ„ØªØ± Ø§Ù„Ù…Ø§Ù„Ùƒ - Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰ */}
                          <Grid item xs={12} md={3}>
                              <FormControl fullWidth>
                                  <InputLabel>Ù¡. Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ù„Ùƒ ({owners.length} Ù…Ø§Ù„Ùƒ)</InputLabel>
                                  <Select
                                      value={selectedOwner}
                                      onChange={(e) => setSelectedOwner(e.target.value)}
                                  >
                                      <MenuItem value="">ÙƒÙ„ Ø§Ù„Ù…ÙÙ„Ø§Ùƒ</MenuItem>
                                      {owners.length === 0 ? (
                                          <MenuItem value="" disabled>
                                              {loading ? "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„..." : "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙÙ„Ø§Ùƒ"}
                                          </MenuItem>
                                      ) : (
                                          owners.map((owner) => (
                                              <MenuItem key={owner.id} value={owner.id}>
                                                  {owner.name ? 
                                                      owner.name.replace(/\t/g, '').trim() : 
                                                      `${owner.firstName || ''} ${owner.lastName || ''}`.trim() || 
                                                      `Ù…Ø§Ù„Ùƒ Ø±Ù‚Ù… ${owner.id}`
                                                  }
                                              </MenuItem>
                                          ))
                                      )}
                                  </Select>
                              </FormControl>
                          </Grid>
                          
                          {/* ÙÙ„ØªØ± Ø§Ù„Ø¹Ù‚Ø§Ø± - Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ø«Ø§Ù†ÙŠØ© */}
                          <Grid item xs={12} md={3}>
                              <FormControl fullWidth>
                                  <InputLabel>Ù¢. Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù‚Ø§Ø± ({filteredProperties.length} Ø¹Ù‚Ø§Ø±)</InputLabel>
                                  <Select
                                      value={selectedProperty}
                                      onChange={(e) => setSelectedProperty(e.target.value)}
                                      disabled={!selectedOwner} // ØªØ¹Ø·ÙŠÙ„ Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ø§Ù„Ùƒ
                                  >
                                      <MenuItem value="">ÙƒÙ„ Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª</MenuItem>
                                      {filteredProperties.length === 0 ? (
                                          <MenuItem value="" disabled>
                                              {!selectedOwner ? "Ø§Ø®ØªØ± Ù…Ø§Ù„ÙƒØ§Ù‹ Ø£ÙˆÙ„Ø§Ù‹" : "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù‚Ø§Ø±Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø§Ù„Ùƒ"}
                                          </MenuItem>
                                      ) : (
                                          filteredProperties.map((property) => (
                                              <MenuItem key={property.id} value={property.id}>
                                                  {property.name ? 
                                                      property.name.replace(/\t/g, '').trim() : 
                                                      `Ø¹Ù‚Ø§Ø± Ø±Ù‚Ù… ${property.id}`
                                                  }
                                              </MenuItem>
                                          ))
                                      )}
                                  </Select>
                              </FormControl>
                          </Grid>
                          
                          {/* ÙÙ„ØªØ± Ù†ÙˆØ¹ Ø§Ù„ÙØ§ØªÙˆØ±Ø© - Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ø«Ø§Ù„Ø«Ø© */}
                          <Grid item xs={12} md={3}>
                              <FormControl fullWidth>
                                  <InputLabel>Ù£. Ù†ÙˆØ¹ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</InputLabel>
                                  <Select
                                        value={invoiceType}
                                        onChange={(e) => setInvoiceType(e.target.value)}
                                  >
                                      {Object.entries(invoiceTypeMapping).map(([key, value]) => (
                                            <MenuItem key={key} value={key}>
                                                {value}
                                            </MenuItem>
                                      ))}
                                  </Select>
                              </FormControl>
                          </Grid>
                      </Grid>
                      
                      {/* Ø²Ø± Ø¬Ù„Ø¨ Ø§Ù„ÙÙˆØ§ØªÙŠØ± */}
                      <Grid container spacing={3} sx={{ mt: 2 }}>
                          <Grid item xs={12}>
                              <Box sx={{ display: 'flex', justifyContent: 'center' }}>
                                  <Button
                                        variant="contained"
                                        color="primary"
                                        size="large"
                                        onClick={handleGenerateInvoices}
                                        disabled={submitLoading}
                                        sx={{ minWidth: '200px', height: '56px' }}
                                  >
                                      {submitLoading ? <CircularProgress size={24}/> : "ğŸ” Ø¬Ù„Ø¨ Ø§Ù„ÙÙˆØ§ØªÙŠØ±"}
                                  </Button>
                              </Box>
                          </Grid>
                      </Grid>
                  </Card>
                  
                  {/* Ø¹Ø±Ø¶ Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */}
                  {invoices.length > 0 && (
                      <InvoiceStatsCards invoices={filteredInvoices} />
                  )}

                  {/* Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© */}
                  {invoices.length > 0 && (
                      <Card sx={{ mb: 3, p: 2 }}>
                          <Box sx={{ display: 'flex', alignItems: 'center', gap: 2, mb: 2 }}>
                              <Typography variant="h6" sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                                  <FilterList />
                                  Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙÙ„Ø§ØªØ±
                              </Typography>
                              <Button 
                                  size="small" 
                                  onClick={() => setShowAdvancedFilters(!showAdvancedFilters)}
                              >
                                  {showAdvancedFilters ? 'Ø¥Ø®ÙØ§Ø¡' : 'Ø¥Ø¸Ù‡Ø§Ø±'} Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
                              </Button>
                              <Box sx={{ flexGrow: 1 }} />
                              <Button 
                                  variant="contained" 
                                  startIcon={<GetApp />}
                                  onClick={handleExportToExcel}
                                  disabled={filteredInvoices.length === 0}
                              >
                                  ØªØµØ¯ÙŠØ± Excel
                              </Button>
                          </Box>

                          {/* Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø³Ø±ÙŠØ¹ */}
                          <TextField
                              fullWidth
                              variant="outlined"
                              placeholder="Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ± (Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©ØŒ Ø§Ø³Ù… Ø§Ù„Ø¹Ù‚Ø§Ø±ØŒ Ø±Ù‚Ù… Ø§Ù„ÙˆØ­Ø¯Ø©...)"
                              value={searchTerm}
                              onChange={(e) => setSearchTerm(e.target.value)}
                              InputProps={{
                                  startAdornment: <Search sx={{ mr: 1, color: 'text.secondary' }} />,
                                  endAdornment: searchTerm && (
                                      <Clear 
                                          sx={{ cursor: 'pointer', color: 'text.secondary' }} 
                                          onClick={() => setSearchTerm('')}
                                      />
                                  )
                              }}
                              sx={{ mb: 2 }}
                          />

                          {/* Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© */}
                          <Collapse in={showAdvancedFilters}>
                              <Grid container spacing={2}>
                                  <Grid item xs={12} sm={6} md={4}>
                                      <FormControl fullWidth>
                                          <InputLabel>Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹</InputLabel>
                                          <Select
                                              value={paymentStatusFilter}
                                              onChange={(e) => setPaymentStatusFilter(e.target.value)}
                                          >
                                              <MenuItem value="ALL">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</MenuItem>
                                              <MenuItem value="PAID">Ù…Ø¯ÙÙˆØ¹Ø©</MenuItem>
                                              <MenuItem value="PENDING">Ù…Ø¹Ù„Ù‚Ø©</MenuItem>
                                              <MenuItem value="OVERDUE">Ù…ØªØ£Ø®Ø±Ø©</MenuItem>
                                          </Select>
                                      </FormControl>
                                  </Grid>
                                  <Grid item xs={12} sm={6} md={4}>
                                      <Box sx={{ display: 'flex', gap: 1, alignItems: 'center', height: '100%' }}>
                                          <Button 
                                              variant="outlined" 
                                              onClick={() => {
                                                  setInvoiceType("ALL");
                                                  setPaymentStatusFilter("ALL");
                                                  setSelectedOwner("");
                                                  setSelectedProperty("");
                                                  setSearchTerm("");
                                              }}
                                              startIcon={<Clear />}
                                          >
                                              Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±
                                          </Button>
                                      </Box>
                                  </Grid>
                              </Grid>
                              
                              {/* Ø¹Ø±Ø¶ Ø¹Ø¯Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ */}
                              <Typography variant="body2" color="text.secondary" sx={{ mt: 2 }}>
                                  Ø¹Ø±Ø¶ {filteredInvoices.length} Ù…Ù† Ø£ØµÙ„ {invoices.length} ÙØ§ØªÙˆØ±Ø©
                              </Typography>
                          </Collapse>
                      </Card>
                  )}

                  {filteredInvoices?.length > 0 && (
                        <Box
                              sx={{mt: 4, p: 2, border: "1px solid #ddd"}}
                              ref={componentRef}
                        >
                            {renderInvoices(filteredInvoices)}
                        </Box>
                  )}

                  {invoices.length > 0 && filteredInvoices.length === 0 && (
                        <Card sx={{ mt: 4, p: 4, textAlign: 'center' }}>
                            <Typography variant="h6" color="text.secondary">
                                Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± ØªØ·Ø§Ø¨Ù‚ Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
                            </Typography>
                            <Typography variant="body2" color="text.secondary" sx={{ mt: 1 }}>
                                Ø¬Ø±Ø¨ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙÙ„Ø§ØªØ± Ø£Ùˆ Ù…Ø³Ø­Ù‡Ø§ Ù„Ù„Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ±
                            </Typography>
                        </Card>
                  )}

                  {printLoading && <CircularProgress/>}

                  {currentInvoice && (
                        <div style={{display: "none"}}>
                            <InvoicePrint ref={printRef} invoice={currentInvoice}/>
                        </div>
                  )}

                  <Snackbar
                        open={snackbarOpen}
                        autoHideDuration={6000}
                        onClose={() => {
                            setSnackbarOpen(false);
                            setErrorMessage("");
                        }}
                  >
                      <Alert 
                          onClose={() => {
                              setSnackbarOpen(false);
                              setErrorMessage("");
                          }} 
                          severity={authError ? "warning" : errorMessage ? "error" : "success"}
                      >
                          {errorMessage || "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­!"}
                      </Alert>
                  </Snackbar>
              </Box>
          </Container>
    );
};

export default InvoicePage;
