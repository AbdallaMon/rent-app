import { NextRequest, NextResponse } from 'next/server';
import { PrismaClient } from '@prisma/client';
import { sendInteractiveWhatsAppMessage, sendWhatsAppMessage } from '@/lib/whatsapp';

let prisma;

function getPrismaClient() {
  if (!prisma) {
    prisma = new PrismaClient();
  }
  return prisma;
}

// Store user sessions and conversation state
const userSessions = new Map();
const processedWebhookIds = new Set();

// Enhanced message templates with better structured options
const enhancedMessages = {
  welcomeMessage: {
    ar: "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ! ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ØŸ",
    en: "Welcome! How can we help you today?"
  },
  mainMenuOptions: {
    ar: {
      header: "Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡",
      body: "ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„ØªÙŠ ØªØ­ØªØ§Ø¬Ù‡Ø§:",
      footer: "Ù†Ø­Ù† Ù‡Ù†Ø§ Ù„Ø®Ø¯Ù…ØªÙƒ 24/7",
      button: "Ø§Ø®ØªØ± Ø§Ù„Ø®Ø¯Ù…Ø©",
      sections: [
        {
          title: "Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©",
          rows: [
            {
              id: "maintenance_request",
              title: "ðŸ”§ Ø·Ù„Ø¨ ØµÙŠØ§Ù†Ø©",
              description: "Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø± Ø£Ùˆ Ø§Ù„ÙˆØ­Ø¯Ø©"
            },
            {
              id: "submit_complaint", 
              title: "ðŸ“ ØªÙ‚Ø¯ÙŠÙ… Ø´ÙƒÙˆÙ‰",
              description: "ØªÙ‚Ø¯ÙŠÙ… Ø´ÙƒÙˆÙ‰ Ø£Ùˆ Ø§Ù‚ØªØ±Ø§Ø­ Ù„Ù„ØªØ­Ø³ÙŠÙ†"
            },
            {
              id: "check_status",
              title: "ðŸ“Š Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª",
              description: "Ù…ØªØ§Ø¨Ø¹Ø© Ø­Ø§Ù„Ø© Ø·Ù„Ø¨Ø§ØªÙƒ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©"
            },
            {
              id: "contact_support",
              title: "â˜Žï¸ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¯Ø¹Ù…",
              description: "Ø§Ù„ØªØ­Ø¯Ø« Ù…Ø¹ Ù…Ù…Ø«Ù„ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡"
            }
          ]
        }
      ]
    },
    en: {
      header: "Customer Services",
      body: "Please select the service you need:",
      footer: "We're here to serve you 24/7",
      button: "Select Service",
      sections: [
        {
          title: "Available Services",
          rows: [
            {
              id: "maintenance_request",
              title: "ðŸ”§ Maintenance Request",
              description: "Report an issue with your property or unit"
            },
            {
              id: "submit_complaint",
              title: "ðŸ“ Submit Complaint", 
              description: "Submit a complaint or suggestion"
            },
            {
              id: "check_status",
              title: "ðŸ“Š Check Status",
              description: "Track your previous requests"
            },
            {
              id: "contact_support",
              title: "â˜Žï¸ Contact Support",
              description: "Speak with customer service"
            }
          ]
        }
      ]
    }
  },
  
  // Maintenance request flow
  maintenanceTypeOptions: {
    ar: {
      header: "Ù†ÙˆØ¹ Ø·Ù„Ø¨ Ø§Ù„ØµÙŠØ§Ù†Ø©",
      body: "Ù…Ø§ Ù†ÙˆØ¹ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„ØªÙŠ ØªÙˆØ§Ø¬Ù‡Ù‡Ø§ØŸ",
      footer: "Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ø£Ù‚Ø±Ø¨ Ù„Ù…Ø´ÙƒÙ„ØªÙƒ",
      button: "Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹",
      sections: [
        {
          title: "Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„ØµÙŠØ§Ù†Ø©",
          rows: [
            {
              id: "plumbing",
              title: "ðŸš¿ Ø³Ø¨Ø§ÙƒØ©",
              description: "Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù…ÙŠØ§Ù‡ ÙˆØ§Ù„ØµØ±Ù Ø§Ù„ØµØ­ÙŠ"
            },
            {
              id: "electrical",
              title: "âš¡ ÙƒÙ‡Ø±Ø¨Ø§Ø¡",
              description: "Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡ ÙˆØ§Ù„Ø¥Ø¶Ø§Ø¡Ø©"
            },
            {
              id: "ac_heating",
              title: "â„ï¸ ØªÙƒÙŠÙŠÙ ÙˆØªØ¯ÙØ¦Ø©",
              description: "Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ØªÙƒÙŠÙŠÙ ÙˆØ§Ù„ØªØ¯ÙØ¦Ø©"
            },
            {
              id: "appliances",
              title: "ðŸ  Ø£Ø¬Ù‡Ø²Ø© Ù…Ù†Ø²Ù„ÙŠØ©",
              description: "Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ©"
            },
            {
              id: "structural",
              title: "ðŸ—ï¸ Ø¥Ù†Ø´Ø§Ø¦ÙŠØ©",
              description: "Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø£Ø¨ÙˆØ§Ø¨ ÙˆØ§Ù„Ù†ÙˆØ§ÙØ° ÙˆØ§Ù„Ø¬Ø¯Ø±Ø§Ù†"
            },
            {
              id: "other_maintenance",
              title: "ðŸ”§ Ø£Ø®Ø±Ù‰",
              description: "Ù…Ø´Ø§ÙƒÙ„ ØµÙŠØ§Ù†Ø© Ø£Ø®Ø±Ù‰"
            }
          ]
        }
      ]
    },
    en: {
      header: "Maintenance Request Type",
      body: "What type of issue are you experiencing?",
      footer: "Choose the type closest to your issue",
      button: "Select Type",
      sections: [
        {
          title: "Maintenance Types",
          rows: [
            {
              id: "plumbing",
              title: "ðŸš¿ Plumbing",
              description: "Water and drainage issues"
            },
            {
              id: "electrical",
              title: "âš¡ Electrical",
              description: "Electrical and lighting issues"
            },
            {
              id: "ac_heating",
              title: "â„ï¸ AC & Heating",
              description: "Air conditioning and heating issues"
            },
            {
              id: "appliances",
              title: "ðŸ  Appliances",
              description: "Home appliance issues"
            },
            {
              id: "structural",
              title: "ðŸ—ï¸ Structural",
              description: "Doors, windows, and wall issues"
            },
            {
              id: "other_maintenance",
              title: "ðŸ”§ Other",
              description: "Other maintenance issues"
            }
          ]
        }
      ]
    }
  },

  // Priority selection
  priorityOptions: {
    ar: {
      header: "Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ø·Ù„Ø¨",
      body: "Ù…Ø§ Ù…Ø¯Ù‰ Ø¥Ù„Ø­Ø§Ø­ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©ØŸ",
      footer: "Ø³ÙŠØ³Ø§Ø¹Ø¯Ù†Ø§ Ù‡Ø°Ø§ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©",
      button: "Ø§Ø®ØªØ± Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©",
      sections: [
        {
          title: "Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©",
          rows: [
            {
              id: "urgent",
              title: "ðŸ”´ Ø¹Ø§Ø¬Ù„",
              description: "Ù…Ø´ÙƒÙ„Ø© Ø·Ø§Ø±Ø¦Ø© ØªØ­ØªØ§Ø¬ Ø­Ù„ ÙÙˆØ±ÙŠ"
            },
            {
              id: "high",
              title: "ðŸŸ  Ø¹Ø§Ù„ÙŠØ©",
              description: "Ù…Ø´ÙƒÙ„Ø© Ù…Ù‡Ù…Ø© ØªØ­ØªØ§Ø¬ Ø­Ù„ Ø³Ø±ÙŠØ¹"
            },
            {
              id: "medium",
              title: "ðŸŸ¡ Ù…ØªÙˆØ³Ø·Ø©",
              description: "Ù…Ø´ÙƒÙ„Ø© Ø¹Ø§Ø¯ÙŠØ© ÙŠÙ…ÙƒÙ† Ø­Ù„Ù‡Ø§ Ø®Ù„Ø§Ù„ Ø£ÙŠØ§Ù…"
            },
            {
              id: "low",
              title: "ðŸŸ¢ Ù…Ù†Ø®ÙØ¶Ø©",
              description: "Ù…Ø´ÙƒÙ„Ø© Ø¨Ø³ÙŠØ·Ø© ØºÙŠØ± Ø¹Ø§Ø¬Ù„Ø©"
            }
          ]
        }
      ]
    },
    en: {
      header: "Request Priority",
      body: "How urgent is this issue?",
      footer: "This helps us prioritize our response",
      button: "Select Priority",
      sections: [
        {
          title: "Priority Levels",
          rows: [
            {
              id: "urgent",
              title: "ðŸ”´ Urgent",
              description: "Emergency issue requiring immediate solution"
            },
            {
              id: "high",
              title: "ðŸŸ  High",
              description: "Important issue requiring quick solution"
            },
            {
              id: "medium",
              title: "ðŸŸ¡ Medium",
              description: "Normal issue that can be solved within days"
            },
            {
              id: "low",
              title: "ðŸŸ¢ Low",
              description: "Simple non-urgent issue"
            }
          ]
        }
      ]
    }
  },

  // Complaint categories
  complaintCategories: {
    ar: {
      header: "Ù†ÙˆØ¹ Ø§Ù„Ø´ÙƒÙˆÙ‰",
      body: "Ù…Ø§ Ù†ÙˆØ¹ Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ ØªÙ‚Ø¯ÙŠÙ…Ù‡Ø§ØŸ",
      footer: "Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨",
      button: "Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹",
      sections: [
        {
          title: "ØªØµÙ†ÙŠÙØ§Øª Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰",
          rows: [
            {
              id: "property_issue",
              title: "ðŸ  Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø¹Ù‚Ø§Ø±",
              description: "Ù…Ø´Ø§ÙƒÙ„ Ù…ØªØ¹Ù„Ù‚Ø© Ø¨Ø§Ù„Ø¹Ù‚Ø§Ø± Ù†ÙØ³Ù‡"
            },
            {
              id: "rent_issue",
              title: "ðŸ’° Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±",
              description: "Ù…Ø´Ø§ÙƒÙ„ Ù…ØªØ¹Ù„Ù‚Ø© Ø¨Ø§Ù„Ø¯ÙØ¹ Ø£Ùˆ Ø§Ù„ÙÙˆØ§ØªÙŠØ±"
            },
            {
              id: "neighbor_issue",
              title: "ðŸ‘¥ Ù…Ø´ÙƒÙ„Ø© Ù…Ø¹ Ø§Ù„Ø¬ÙŠØ±Ø§Ù†",
              description: "Ù…Ø´Ø§ÙƒÙ„ Ù…Ø¹ Ø§Ù„Ø¬ÙŠØ±Ø§Ù† Ø£Ùˆ Ø§Ù„Ø³ÙƒØ§Ù†"
            },
            {
              id: "maintenance_issue",
              title: "ðŸ”§ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„ØµÙŠØ§Ù†Ø©",
              description: "Ø´ÙƒÙˆÙ‰ Ø­ÙˆÙ„ Ø®Ø¯Ù…Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©"
            },
            {
              id: "noise_issue",
              title: "ðŸ”Š Ù…Ø´ÙƒÙ„Ø© Ø¶ÙˆØ¶Ø§Ø¡",
              description: "Ø´ÙƒØ§ÙˆÙ‰ Ù…ØªØ¹Ù„Ù‚Ø© Ø¨Ø§Ù„Ø¶ÙˆØ¶Ø§Ø¡"
            },
            {
              id: "security_issue",
              title: "ðŸ›¡ï¸ Ù…Ø´ÙƒÙ„Ø© Ø£Ù…Ù†ÙŠØ©",
              description: "Ù…Ø´Ø§ÙƒÙ„ Ø£Ù…Ù†ÙŠØ© ÙÙŠ Ø§Ù„Ù…Ø¨Ù†Ù‰"
            },
            {
              id: "payment_issue",
              title: "ðŸ’³ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø¯ÙØ¹",
              description: "Ù…Ø´Ø§ÙƒÙ„ ÙÙŠ Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¯ÙØ¹"
            },
            {
              id: "other_complaint",
              title: "ðŸ“ Ø£Ø®Ø±Ù‰",
              description: "Ø´ÙƒÙˆÙ‰ Ø£Ø®Ø±Ù‰ ØºÙŠØ± Ù…ØµÙ†ÙØ©"
            }
          ]
        }
      ]
    },
    en: {
      header: "Complaint Type",
      body: "What type of complaint would you like to submit?",
      footer: "Choose the appropriate category",
      button: "Select Type",
      sections: [
        {
          title: "Complaint Categories",
          rows: [
            {
              id: "property_issue",
              title: "ðŸ  Property Issue",
              description: "Issues related to the property itself"
            },
            {
              id: "rent_issue",
              title: "ðŸ’° Rent Issue",
              description: "Issues related to payment or billing"
            },
            {
              id: "neighbor_issue",
              title: "ðŸ‘¥ Neighbor Issue",
              description: "Issues with neighbors or residents"
            },
            {
              id: "maintenance_issue",
              title: "ðŸ”§ Maintenance Issue",
              description: "Complaints about maintenance service"
            },
            {
              id: "noise_issue",
              title: "ðŸ”Š Noise Issue",
              description: "Noise-related complaints"
            },
            {
              id: "security_issue",
              title: "ðŸ›¡ï¸ Security Issue",
              description: "Security issues in the building"
            },
            {
              id: "payment_issue",
              title: "ðŸ’³ Payment Issue",
              description: "Payment processing issues"
            },
            {
              id: "other_complaint",
              title: "ðŸ“ Other",
              description: "Other unclassified complaint"
            }
          ]
        }
      ]
    }
  }
};

// Helper function to get localized messages
const getLocalizedMessages = (language, messageKey) => {
  const lang = language === 'ARABIC' ? 'ar' : 'en';
  return enhancedMessages[messageKey]?.[lang] || enhancedMessages[messageKey]?.en;
};

// Find client by phone number
const findClientByPhone = async (phoneNumber, prisma) => {
  try {
    const cleanPhone = phoneNumber.replace(/^\+966/, '0').replace(/^\+/, '');
    
    const client = await prisma.client.findFirst({
      where: {
        OR: [
          { phone: phoneNumber },
          { phone: cleanPhone },
          { phone: phoneNumber.replace(/^\+/, '') },
          { phone: `+966${cleanPhone.replace(/^0/, '')}` }
        ]
      }
    });
    
    return client;
  } catch (error) {
    console.error('Error finding client by phone:', error);
    return null;
  }
};

// Session management
const createSession = (phoneNumber, language) => {
  const session = {
    phoneNumber,
    language,
    step: 'main_menu',
    data: {},
    timestamp: Date.now()
  };
  userSessions.set(phoneNumber, session);
  return session;
};

const getSession = (phoneNumber) => {
  return userSessions.get(phoneNumber);
};

const updateSession = (phoneNumber, updates) => {
  const session = getSession(phoneNumber) || createSession(phoneNumber, 'ENGLISH');
  Object.assign(session, updates, { timestamp: Date.now() });
  userSessions.set(phoneNumber, session);
  return session;
};

// Enhanced main menu sender
const sendMainMenu = async (phoneNumber, language) => {
  try {
    const menuOptions = getLocalizedMessages(language, 'mainMenuOptions');
    
    const interactiveContent = {
      type: "list",
      header: {
        type: "text",
        text: menuOptions.header
      },
      body: {
        text: menuOptions.body
      },
      footer: {
        text: menuOptions.footer
      },
      action: {
        button: menuOptions.button,
        sections: menuOptions.sections
      }
    };
    
    await sendInteractiveWhatsAppMessage(phoneNumber, interactiveContent);
    updateSession(phoneNumber, { step: 'awaiting_main_menu_selection', language });
  } catch (error) {
    console.error('Error sending main menu:', error);
    await sendWhatsAppMessage(phoneNumber, "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£. / Sorry, an error occurred.");
  }
};

// Enhanced maintenance type selector
const sendMaintenanceTypeOptions = async (phoneNumber, language) => {
  try {
    const typeOptions = getLocalizedMessages(language, 'maintenanceTypeOptions');
    
    const interactiveContent = {
      type: "list",
      header: {
        type: "text",
        text: typeOptions.header
      },
      body: {
        text: typeOptions.body
      },
      footer: {
        text: typeOptions.footer
      },
      action: {
        button: typeOptions.button,
        sections: typeOptions.sections
      }
    };
    
    await sendInteractiveWhatsAppMessage(phoneNumber, interactiveContent);
    updateSession(phoneNumber, { step: 'awaiting_maintenance_type' });
  } catch (error) {
    console.error('Error sending maintenance type options:', error);
    await sendWhatsAppMessage(phoneNumber, "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£. / Sorry, an error occurred.");
  }
};

// Priority selector
const sendPriorityOptions = async (phoneNumber, language) => {
  try {
    const priorityOptions = getLocalizedMessages(language, 'priorityOptions');
    
    const interactiveContent = {
      type: "list",
      header: {
        type: "text",
        text: priorityOptions.header
      },
      body: {
        text: priorityOptions.body
      },
      footer: {
        text: priorityOptions.footer
      },
      action: {
        button: priorityOptions.button,
        sections: priorityOptions.sections
      }
    };
    
    await sendInteractiveWhatsAppMessage(phoneNumber, interactiveContent);
    updateSession(phoneNumber, { step: 'awaiting_priority_selection' });
  } catch (error) {
    console.error('Error sending priority options:', error);
    await sendWhatsAppMessage(phoneNumber, "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£. / Sorry, an error occurred.");
  }
};

// Complaint category selector
const sendComplaintCategories = async (phoneNumber, language) => {
  try {
    const categoryOptions = getLocalizedMessages(language, 'complaintCategories');
    
    const interactiveContent = {
      type: "list",
      header: {
        type: "text",
        text: categoryOptions.header
      },
      body: {
        text: categoryOptions.body
      },
      footer: {
        text: categoryOptions.footer
      },
      action: {
        button: categoryOptions.button,
        sections: categoryOptions.sections
      }
    };
    
    await sendInteractiveWhatsAppMessage(phoneNumber, interactiveContent);
    updateSession(phoneNumber, { step: 'awaiting_complaint_category' });
  } catch (error) {
    console.error('Error sending complaint categories:', error);
    await sendWhatsAppMessage(phoneNumber, "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£. / Sorry, an error occurred.");
  }
};

// Handle interactive responses with enhanced flow
const handleInteractiveResponse = async (interactive, phoneNumber, prisma) => {
  try {
    const session = getSession(phoneNumber) || createSession(phoneNumber, 'ENGLISH');
    const language = session.language;
    
    if (interactive.list_reply) {
      const selectedOption = interactive.list_reply.id;
      
      switch (session.step) {
        case 'awaiting_main_menu_selection':
          await handleMainMenuSelection(selectedOption, phoneNumber, language, prisma);
          break;
          
        case 'awaiting_maintenance_type':
          updateSession(phoneNumber, { 
            step: 'awaiting_priority_selection',
            data: { ...session.data, maintenanceType: selectedOption }
          });
          await sendPriorityOptions(phoneNumber, language);
          break;
          
        case 'awaiting_priority_selection':
          updateSession(phoneNumber, { 
            step: 'awaiting_description',
            data: { ...session.data, priority: selectedOption }
          });
          const promptMsg = language === 'ARABIC' ? 
            "ÙŠØ±Ø¬Ù‰ ÙˆØµÙ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø¨Ø§Ù„ØªÙØµÙŠÙ„:" : 
            "Please describe the issue in detail:";
          await sendWhatsAppMessage(phoneNumber, promptMsg);
          break;
          
        case 'awaiting_complaint_category':
          updateSession(phoneNumber, { 
            step: 'awaiting_complaint_description',
            data: { ...session.data, category: selectedOption }
          });
          const complaintPrompt = language === 'ARABIC' ? 
            "ÙŠØ±Ø¬Ù‰ ÙˆØµÙ Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø¨Ø§Ù„ØªÙØµÙŠÙ„:" : 
            "Please describe your complaint in detail:";
          await sendWhatsAppMessage(phoneNumber, complaintPrompt);
          break;
      }
    }
  } catch (error) {
    console.error('Error handling interactive response:', error);
  }
};

// Handle main menu selection
const handleMainMenuSelection = async (selectedOption, phoneNumber, language, prisma) => {
  const client = await findClientByPhone(phoneNumber, prisma);
  
  if (!client) {
    const notFoundMsg = language === 'ARABIC' ? 
      "Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø­Ø³Ø§Ø¨Ùƒ ÙÙŠ Ù†Ø¸Ø§Ù…Ù†Ø§. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù…ÙƒØªØ¨Ù†Ø§ Ù…Ø¨Ø§Ø´Ø±Ø©." :
      "We couldn't find your account in our system. Please contact our office directly.";
    await sendWhatsAppMessage(phoneNumber, notFoundMsg);
    return;
  }
  
  switch (selectedOption) {
    case 'maintenance_request':
      await sendMaintenanceTypeOptions(phoneNumber, language);
      break;
      
    case 'submit_complaint':
      await sendComplaintCategories(phoneNumber, language);
      break;
      
    case 'check_status':
      await handleStatusCheck(phoneNumber, language, client, prisma);
      break;
      
    case 'contact_support':
      await handleContactSupport(phoneNumber, language, client, prisma);
      break;
      
    default:
      await sendMainMenu(phoneNumber, language);
  }
};

// Enhanced maintenance request creation
const createEnhancedMaintenanceRequest = async (phoneNumber, description, session, prisma) => {
  try {
    const client = await findClientByPhone(phoneNumber, prisma);
    if (!client) return;
    
    const { maintenanceType, priority } = session.data;
    
    // Map priority values to database enum
    const priorityMap = {
      'urgent': 'URGENT',
      'high': 'HIGH', 
      'medium': 'MEDIUM',
      'low': 'LOW'
    };
    
    const clientProperties = await prisma.property.findMany({
      where: { clientId: client.id }
    });
    
    const clientUnits = await prisma.unit.findMany({
      where: { clientId: client.id }
    });
    
    const maintenanceRequest = await prisma.maintenanceRequest.create({
      data: {
        clientId: client.id,
        propertyId: clientProperties.length > 0 ? clientProperties[0].id : null,
        unitId: clientUnits.length > 0 ? clientUnits[0].id : null,
        description: `[${maintenanceType.toUpperCase()}] ${description}`,
        status: 'PENDING',
        priority: priorityMap[priority] || 'MEDIUM',
        isExpired: false,
        lastRequestTime: new Date()
      }
    });
    
    const successMsg = session.language === 'ARABIC' ? 
      `ØªÙ… ØªÙ‚Ø¯ÙŠÙ… Ø·Ù„Ø¨ Ø§Ù„ØµÙŠØ§Ù†Ø© Ø¨Ù†Ø¬Ø§Ø­!\n\nØ±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: #${maintenanceRequest.id}\nØ§Ù„Ù†ÙˆØ¹: ${maintenanceType}\nØ§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©: ${priority}\nØ§Ù„ÙˆØµÙ: ${description}\n\nØ³ÙŠÙ‚ÙˆÙ… ÙØ±ÙŠÙ‚Ù†Ø§ Ø¨Ù…Ø±Ø§Ø¬Ø¹ØªÙ‡ Ù‚Ø±ÙŠØ¨Ø§Ù‹.` :
      `Maintenance request submitted successfully!\n\nRequest #: ${maintenanceRequest.id}\nType: ${maintenanceType}\nPriority: ${priority}\nDescription: ${description}\n\nOur team will review it soon.`;
    
    await sendWhatsAppMessage(phoneNumber, successMsg);
    
    // Reset session
    userSessions.delete(phoneNumber);
    
  } catch (error) {
    console.error('Error creating enhanced maintenance request:', error);
    await sendWhatsAppMessage(phoneNumber, "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£. / Sorry, an error occurred.");
  }
};

// Enhanced complaint creation
const createEnhancedComplaint = async (phoneNumber, description, session, prisma) => {
  try {
    const client = await findClientByPhone(phoneNumber, prisma);
    if (!client) return;
    
    const { category } = session.data;
    
    // Map category values to database enum
    const categoryMap = {
      'property_issue': 'PROPERTY_ISSUE',
      'rent_issue': 'RENT_ISSUE',
      'neighbor_issue': 'NEIGHBOR_ISSUE',
      'maintenance_issue': 'MAINTENANCE_ISSUE',
      'noise_issue': 'NOISE_ISSUE',
      'security_issue': 'SECURITY_ISSUE',
      'payment_issue': 'PAYMENT_ISSUE',
      'other_complaint': 'OTHER'
    };
    
    const clientProperties = await prisma.property.findMany({
      where: { clientId: client.id }
    });
    
    const clientUnits = await prisma.unit.findMany({
      where: { clientId: client.id }
    });
    
    const complaint = await prisma.complaint.create({
      data: {
        clientId: client.id,
        propertyId: clientProperties.length > 0 ? clientProperties[0].id : null,
        unitId: clientUnits.length > 0 ? clientUnits[0].id : null,
        title: description.length > 50 ? description.substring(0, 50) + "..." : description,
        description: description,
        category: categoryMap[category] || 'OTHER',
        status: 'PENDING'
      }
    });
    
    const successMsg = session.language === 'ARABIC' ? 
      `ØªÙ… ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ø´ÙƒÙˆÙ‰ Ø¨Ù†Ø¬Ø§Ø­!\n\nØ±Ù‚Ù… Ø§Ù„Ø´ÙƒÙˆÙ‰: #${complaint.id}\nØ§Ù„ØªØµÙ†ÙŠÙ: ${category}\nØ§Ù„ÙˆØµÙ: ${description}\n\nØ³ÙŠÙ‚ÙˆÙ… ÙØ±ÙŠÙ‚Ù†Ø§ Ø¨Ù…Ø±Ø§Ø¬Ø¹ØªÙ‡Ø§ Ù‚Ø±ÙŠØ¨Ø§Ù‹.` :
      `Complaint submitted successfully!\n\nComplaint #: ${complaint.id}\nCategory: ${category}\nDescription: ${description}\n\nOur team will review it soon.`;
    
    await sendWhatsAppMessage(phoneNumber, successMsg);
    
    // Reset session
    userSessions.delete(phoneNumber);
    
  } catch (error) {
    console.error('Error creating enhanced complaint:', error);
    await sendWhatsAppMessage(phoneNumber, "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£. / Sorry, an error occurred.");
  }
};

// Handle text messages based on session state
const handleTextMessage = async (messageText, phoneNumber, prisma) => {
  const session = getSession(phoneNumber);
  
  if (!session) {
    // No active session, start fresh
    const client = await findClientByPhone(phoneNumber, prisma);
    const language = client?.language || 'ENGLISH';
    await sendMainMenu(phoneNumber, language);
    return;
  }
  
  switch (session.step) {
    case 'awaiting_description':
      await createEnhancedMaintenanceRequest(phoneNumber, messageText, session, prisma);
      break;
      
    case 'awaiting_complaint_description':
      await createEnhancedComplaint(phoneNumber, messageText, session, prisma);
      break;
      
    default:
      // Unknown step, restart
      const client = await findClientByPhone(phoneNumber, prisma);
      const language = client?.language || session.language || 'ENGLISH';
      await sendMainMenu(phoneNumber, language);
  }
};

// Status check functionality
const handleStatusCheck = async (phoneNumber, language, client, prisma) => {
  try {
    // Get recent requests and complaints
    const recentRequests = await prisma.maintenanceRequest.findMany({
      where: { clientId: client.id },
      orderBy: { createdAt: 'desc' },
      take: 5
    });
    
    const recentComplaints = await prisma.complaint.findMany({
      where: { clientId: client.id },
      orderBy: { createdAt: 'desc' },
      take: 5
    });
    
    let statusMessage = language === 'ARABIC' ? 
      "Ø­Ø§Ù„Ø© Ø·Ù„Ø¨Ø§ØªÙƒ Ø§Ù„Ø£Ø®ÙŠØ±Ø©:\n\n" : 
      "Your recent requests status:\n\n";
    
    if (recentRequests.length > 0) {
      statusMessage += language === 'ARABIC' ? "Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµÙŠØ§Ù†Ø©:\n" : "Maintenance Requests:\n";
      recentRequests.forEach(req => {
        const statusText = language === 'ARABIC' ? 
          { PENDING: 'Ù…Ø¹Ù„Ù‚', IN_PROGRESS: 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©', COMPLETED: 'Ù…ÙƒØªÙ…Ù„', REJECTED: 'Ù…Ø±ÙÙˆØ¶' } :
          { PENDING: 'Pending', IN_PROGRESS: 'In Progress', COMPLETED: 'Completed', REJECTED: 'Rejected' };
        statusMessage += `#${req.id}: ${statusText[req.status]}\n`;
      });
      statusMessage += "\n";
    }
    
    if (recentComplaints.length > 0) {
      statusMessage += language === 'ARABIC' ? "Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰:\n" : "Complaints:\n";
      recentComplaints.forEach(comp => {
        const statusText = language === 'ARABIC' ? 
          { PENDING: 'Ù…Ø¹Ù„Ù‚', REVIEWING: 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©', RESOLVED: 'Ù…Ø­Ù„ÙˆÙ„', REJECTED: 'Ù…Ø±ÙÙˆØ¶' } :
          { PENDING: 'Pending', REVIEWING: 'Reviewing', RESOLVED: 'Resolved', REJECTED: 'Rejected' };
        statusMessage += `#${comp.id}: ${statusText[comp.status]}\n`;
      });
    }
    
    if (recentRequests.length === 0 && recentComplaints.length === 0) {
      statusMessage = language === 'ARABIC' ? 
        "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø³Ø§Ø¨Ù‚Ø©." : 
        "No previous requests found.";
    }
    
    await sendWhatsAppMessage(phoneNumber, statusMessage);
    
    // Return to main menu
    setTimeout(() => {
      sendMainMenu(phoneNumber, language);
    }, 2000);
    
  } catch (error) {
    console.error('Error checking status:', error);
    await sendWhatsAppMessage(phoneNumber, "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£. / Sorry, an error occurred.");
  }
};

// Contact support
const handleContactSupport = async (phoneNumber, language, client, prisma) => {
  try {
    const supportMsg = language === 'ARABIC' ? 
      "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ù„Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ. Ø³ÙŠØªØµÙ„ Ø¨Ùƒ Ù…Ù…Ø«Ù„ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø®Ù„Ø§Ù„ 30 Ø¯Ù‚ÙŠÙ‚Ø©." :
      "Your request has been sent to technical support. A customer service representative will contact you within 30 minutes.";
    
    await sendWhatsAppMessage(phoneNumber, supportMsg);
    
    // Log support request
    await prisma.contactForm.create({
      data: {
        name: client.name,
        email: client.email || 'noemail@provided.com',
        phone: phoneNumber,
        message: 'Customer requested support via WhatsApp bot',
        language: language
      }
    });
    
    // Return to main menu after 3 seconds
    setTimeout(() => {
      sendMainMenu(phoneNumber, language);
    }, 3000);
    
  } catch (error) {
    console.error('Error handling contact support:', error);
    await sendWhatsAppMessage(phoneNumber, "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£. / Sorry, an error occurred.");
  }
};

// Main webhook handler
export async function POST(request) {
  try {
    const body = await request.json();
    const prisma = getPrismaClient();
    
    if (body.entry && body.entry[0].changes && body.entry[0].changes[0].value.messages) {
      const message = body.entry[0].changes[0].value.messages[0];
      const phoneNumber = message.from;
      
      // Check for duplicate processing
      const webhookId = `${message.id}_${Date.now()}`;
      if (processedWebhookIds.has(webhookId)) {
        return NextResponse.json({ status: 'already_processed' });
      }
      processedWebhookIds.add(webhookId);
      
      // Handle different message types
      if (message.type === 'text') {
        await handleTextMessage(message.text.body, phoneNumber, prisma);
      } else if (message.type === 'interactive') {
        await handleInteractiveResponse(message.interactive, phoneNumber, prisma);
      }
    }
    
    return NextResponse.json({ status: 'success' });
    
  } catch (error) {
    console.error('Enhanced webhook error:', error);
    return NextResponse.json({ error: 'Internal server error' }, { status: 500 });
  }
}

// Webhook verification
export async function GET(request) {
  const url = new URL(request.url);
  const mode = url.searchParams.get('hub.mode');
  const token = url.searchParams.get('hub.verify_token');
  const challenge = url.searchParams.get('hub.challenge');
  
  if (mode === 'subscribe' && token === process.env.WEBHOOK_VERIFY_TOKEN) {
    return new Response(challenge, { status: 200 });
  }
  
  return new Response('Forbidden', { status: 403 });
}
