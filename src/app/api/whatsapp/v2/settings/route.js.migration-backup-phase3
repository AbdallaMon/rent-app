import { NextResponse } from 'next/server';
import { PrismaClient } from '@prisma/client';
import { cookies } from 'next/headers';
import jwt from 'jsonwebtoken';

const prisma = new PrismaClient();

// Helper function to verify authentication
async function verifyAuth() {
  try {
    const cookieStore = cookies();
    const token = cookieStore.get('token')?.value;
    
    if (!token) {
      return null;
    }
    
    const decoded = jwt.verify(token, process.env.SECRET_KEY);
    
    const user = await prisma.user.findUnique({
      where: { id: decoded.userId },
      include: {
        privileges: {
          where: { area: 'WHATSAPP' },
          include: { privilege: true }
        }
      }
    });
    
    if (!user || !user.privileges.some(p => p.privilege.canRead)) {
      return null;
    }
    
    return user;
  } catch (error) {
    return null;
  }
}

// GET - Ø¬Ù„Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙƒÙŠØ±Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
export async function GET(request) {
  try {    console.log('ğŸ” API Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙƒÙŠØ±Ø§Øª ØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡');
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© (Ù…ÙØ¹Ø·Ù„ Ù…Ø¤Ù‚ØªØ§Ù‹ Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª)
    // const user = await verifyAuth();
    // if (!user) {
    //   return NextResponse.json(
    //     { success: false, error: 'ØºÙŠØ± Ù…ØµØ±Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„' },
    //     { status: 401 }
    //   );
    // }
    
    const user = { name: 'admin' }; // Ù…Ø¤Ù‚Øª

    // Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù† Ø¬Ø¯ÙˆÙ„ ReminderSettings
    let reminderSettings = await prisma.reminderSettings.findFirst({
      where: { id: 'default_reminder_settings' }
    });

    // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§ØªØŒ Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    if (!reminderSettings) {
      console.log('âš ï¸ Ù„Ù… ØªÙˆØ¬Ø¯ Ø¥Ø¹Ø¯Ø§Ø¯Ø§ØªØŒ Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ©...');
      reminderSettings = await prisma.reminderSettings.create({
        data: {
          id: 'default_reminder_settings',
          paymentReminderDays: [7, 3, 1],
          contractReminderDays: [60, 30, 15, 7],
          maintenanceFollowupDays: [3, 7, 14],
          maxRetries: 3,
          messageDelay: 2000,
          enableAutoReminders: true,
          enabledReminderTypes: ['payment_reminder', 'contract_expiry_reminder', 'maintenance_followup'],
          workingHoursStart: '09:00:00',
          workingHoursEnd: '18:00:00',
          workingDays: ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'],
          highPriorityThreshold: 3,
          mediumPriorityThreshold: 7,
          defaultLanguage: 'ar_AE',
          includeCompanySignature: true,
          isActive: true,
          updatedBy: user.name
        }
      });
    }
    
    console.log('âœ… ØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
    return NextResponse.json({
      success: true,
      message: 'ØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',
      settings: {
        id: reminderSettings.id,
        paymentReminderDays: reminderSettings.paymentReminderDays,
        contractReminderDays: reminderSettings.contractReminderDays,
        maintenanceFollowupDays: reminderSettings.maintenanceFollowupDays,
        maxRetries: reminderSettings.maxRetries,
        messageDelay: reminderSettings.messageDelay,
        enableAutoReminders: reminderSettings.enableAutoReminders,
        enabledReminderTypes: reminderSettings.enabledReminderTypes,
        workingHoursStart: reminderSettings.workingHoursStart,
        workingHoursEnd: reminderSettings.workingHoursEnd,
        workingDays: reminderSettings.workingDays,
        highPriorityThreshold: reminderSettings.highPriorityThreshold,
        mediumPriorityThreshold: reminderSettings.mediumPriorityThreshold,
        defaultLanguage: reminderSettings.defaultLanguage,
        includeCompanySignature: reminderSettings.includeCompanySignature,
        isActive: reminderSettings.isActive,
        updatedBy: reminderSettings.updatedBy,
        source: 'ReminderSettings_table'
      }
    });
    
  } catch (error) {
    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙƒÙŠØ±Ø§Øª:', error);
    return NextResponse.json({
      success: false,
      error: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…: ' + error.message
    }, { status: 500 });
  } finally {
    await prisma.$disconnect();
  }
}

// POST - ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙƒÙŠØ±Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
export async function POST(request) {
  try {    console.log('âœï¸ API ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙƒÙŠØ±Ø§Øª ØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¤Ù‡');
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© (Ù…ÙØ¹Ø·Ù„ Ù…Ø¤Ù‚ØªØ§Ù‹ Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª)
    // const user = await verifyAuth();
    // if (!user) {
    //   return NextResponse.json(
    //     { success: false, error: 'ØºÙŠØ± Ù…ØµØ±Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„' },
    //     { status: 401 }
    //   );
    // }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙƒØªØ§Ø¨Ø© (Ù…ÙØ¹Ø·Ù„ Ù…Ø¤Ù‚ØªØ§Ù‹)
    // if (!user.privileges.some(p => p.privilege.canWrite)) {
    //   return NextResponse.json(
    //     { success: false, error: 'Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª' },
    //     { status: 403 }
    //   );
    // }
    
    const user = { name: 'admin' }; // Ù…Ø¤Ù‚Øª
    
    const body = await request.json();
    console.log('ğŸ“¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙØ±Ø³Ù„Ø©:', body);
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const updatedSettings = await prisma.reminderSettings.upsert({
      where: { id: 'default_reminder_settings' },
      update: {
        paymentReminderDays: body.paymentReminderDays || [],
        contractReminderDays: body.contractReminderDays || [],
        maintenanceFollowupDays: body.maintenanceFollowupDays || [3, 7, 14],
        maxRetries: body.maxRetries || 3,
        messageDelay: body.messageDelay || 2000,
        enableAutoReminders: body.enableAutoReminders !== undefined ? body.enableAutoReminders : true,
        enabledReminderTypes: body.enabledReminderTypes || [],
        workingHoursStart: body.workingHoursStart || '09:00:00',
        workingHoursEnd: body.workingHoursEnd || '18:00:00',
        workingDays: body.workingDays || [],
        highPriorityThreshold: body.highPriorityThreshold || 3,
        mediumPriorityThreshold: body.mediumPriorityThreshold || 7,
        defaultLanguage: body.defaultLanguage || 'ar_AE',
        includeCompanySignature: body.includeCompanySignature !== undefined ? body.includeCompanySignature : true,
        isActive: body.isActive !== undefined ? body.isActive : true,
        updatedBy: user.name,
        updatedAt: new Date()
      },
      create: {
        id: 'default_reminder_settings',
        paymentReminderDays: body.paymentReminderDays || [7, 3, 1],
        contractReminderDays: body.contractReminderDays || [60, 30, 15, 7],
        maintenanceFollowupDays: body.maintenanceFollowupDays || [3, 7, 14],
        maxRetries: body.maxRetries || 3,
        messageDelay: body.messageDelay || 2000,
        enableAutoReminders: body.enableAutoReminders !== undefined ? body.enableAutoReminders : true,
        enabledReminderTypes: body.enabledReminderTypes || ['payment_reminder', 'contract_expiry_reminder'],
        workingHoursStart: body.workingHoursStart || '09:00:00',
        workingHoursEnd: body.workingHoursEnd || '18:00:00',
        workingDays: body.workingDays || ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'],
        highPriorityThreshold: body.highPriorityThreshold || 3,
        mediumPriorityThreshold: body.mediumPriorityThreshold || 7,
        defaultLanguage: body.defaultLanguage || 'ar_AE',
        includeCompanySignature: body.includeCompanySignature !== undefined ? body.includeCompanySignature : true,
        isActive: body.isActive !== undefined ? body.isActive : true,
        updatedBy: user.name
      }
    });
    
    console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
    return NextResponse.json({
      success: true,
      message: 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',
      updatedSettings: {
        id: updatedSettings.id,
        paymentReminderDays: updatedSettings.paymentReminderDays,
        contractReminderDays: updatedSettings.contractReminderDays,
        maintenanceFollowupDays: updatedSettings.maintenanceFollowupDays,
        maxRetries: updatedSettings.maxRetries,
        messageDelay: updatedSettings.messageDelay,
        enableAutoReminders: updatedSettings.enableAutoReminders,
        enabledReminderTypes: updatedSettings.enabledReminderTypes,
        workingHoursStart: updatedSettings.workingHoursStart,
        workingHoursEnd: updatedSettings.workingHoursEnd,
        workingDays: updatedSettings.workingDays,
        highPriorityThreshold: updatedSettings.highPriorityThreshold,
        mediumPriorityThreshold: updatedSettings.mediumPriorityThreshold,
        defaultLanguage: updatedSettings.defaultLanguage,
        includeCompanySignature: updatedSettings.includeCompanySignature,
        isActive: updatedSettings.isActive,
        updatedBy: updatedSettings.updatedBy,
        updatedAt: updatedSettings.updatedAt
      }
    });
    
  } catch (error) {
    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ°ÙƒÙŠØ±Ø§Øª:', error);
    return NextResponse.json({
      success: false,
      error: 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…: ' + error.message
    }, { status: 500 });
  } finally {
    await prisma.$disconnect();
  }
}
